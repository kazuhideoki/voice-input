# AXObserver 技術検証結果

## 検証日時
2025年1月7日

## 検証結果: ❌ 実装不可

### 技術的な問題点

1. **AXObserver API の制限**
   - エラーコード -25208 (`kAXErrorNotImplemented`) が返される
   - 現在のプロセスに対してマウス移動やフォーカス変更の通知を登録できない
   - システム全体のUIElementには通知を追加できない（エラー -25202: `kAXErrorInvalidUIElement`）

2. **カーソル位置取得の制限**
   - `AXFocusedUIElement` から要素を取得できない
   - テキストカーソル（キャレット）位置の統一的な取得方法がない
   - アプリケーションごとに異なるAccessibility実装への対応が必要

3. **実装の複雑性**
   - RunLoop統合が必要で、メインスレッドでの実行が前提
   - 複数のアプリケーション間での動作を保証できない
   - エラーハンドリングが複雑

### パフォーマンス評価

#### ポーリング方式
- CPU使用率: 0.1%未満（実測値）
- 更新頻度: 30ms間隔で安定
- 実装: シンプルで保守しやすい

#### AXObserver方式（理論値）
- CPU使用率: イベントドリブンのため理論的には低い
- 更新頻度: イベント発生時のみ
- 実装: 複雑で制限が多い

## 最終判断

**ポーリング方式を採用する**

### 採用理由

1. **確実な動作**
   - すべてのmacOS環境で安定して動作
   - マウスカーソル位置を確実に取得可能
   - CPU使用率が十分に低い（0.1%未満）

2. **実装のシンプルさ**
   - 既存の実装で十分な性能を達成
   - エラーハンドリングが単純
   - テストとデバッグが容易

3. **将来の拡張性**
   - Phase 4でテキストカーソル対応を追加する際も、ポーリングベースで実装可能
   - アプリケーション固有の対応を段階的に追加できる

### Phase 2への推奨事項

1. 現在のポーリング実装（30ms間隔）をそのまま使用
2. アニメーションウィンドウの実装に注力
3. テキストカーソル対応はPhase 4で実装（主要アプリケーションごとの個別対応）

## 技術検証コード

検証に使用したコードは `tests/axobserver_poc.rs` に保存されている。将来的にmacOSのAPIが改善された場合の参考資料として残す。