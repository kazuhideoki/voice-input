# マルチスタッキング機能 残りタスクと改善案

## 概要

dev-docs/multi-stacking で設計・実装されたマルチスタッキング機能の分析結果として、残りタスクと改善案をまとめます。現在の実装状況は**Production Ready（100%完了）**ですが、さらなる機能拡張と改善の可能性があります。

## 現在の実装状況

### ✅ 完了済み機能（Phase 1-4）

- **Phase 1**: 基礎モデルとIPC定義、CLIコマンド拡張
- **Phase 2**: デーモン側スタック管理基盤、音声入力とスタック連携
- **Phase 3**: 基本ペースト機能、スタック管理コマンド完成
- **Phase 4**: 基本UI実装（別プロセス方式、リアルタイム表示）

### 🎯 品質達成状況

- **機能完成度**: 100% - 設計した全機能が実装済み
- **品質保証**: Production Ready - 130+テスト、包括的エラーハンドリング
- **パフォーマンス**: 目標達成 - 60FPS UI、<2MB メモリ使用量
- **ユーザビリティ**: 優秀 - 直感的操作、建設的フィードバック

## 残りタスクと改善案

### 1. 機能拡張（Priority: Medium）

#### 1.1 複数ペースト機能
**概要**: 複数のスタックを一度にペーストする機能

**実装案**:
```bash
# 範囲指定ペースト
voice_input paste 1-3        # スタック1,2,3を順番にペースト
voice_input paste 1,3,5      # 指定番号のみペースト

# 全件ペースト
voice_input paste-all        # 全スタックを順番にペースト
```

**技術的考慮**:
- `PasteMultipleStacks { numbers: Vec<u32> }` IPC拡張
- text_input での順次ペースト処理
- 区切り文字設定（改行、スペース等）

#### 1.2 スタック編集機能
**概要**: 保存済みスタックの内容編集

**実装案**:
```bash
# スタック編集
voice_input edit-stack 2     # スタック2の内容を編集モードで開く
voice_input replace-stack 2 "新しいテキスト"  # スタック2を置換

# スタック削除
voice_input delete-stack 2   # スタック2を削除
```

**技術的考慮**:
- StackServiceでの編集・削除API追加
- UI での編集状態表示
- 編集履歴管理（undo/redo）

#### 1.3 外部フォーマット連携
**概要**: 他のアプリケーション・フォーマットとの連携

**実装案**:
```bash
# クリップボード連携
voice_input copy-stack 1     # スタック1をクリップボードにコピー
voice_input paste-from-clipboard  # クリップボードからスタックに保存

# ファイル出力
voice_input export-stacks --format json  # JSON形式でエクスポート
voice_input export-stacks --format txt   # テキスト形式でエクスポート
```

**技術的考慮**:
- clipboard-rs等のクリップボードライブラリ統合
- ファイルフォーマット対応（JSON, XML, CSV等）
- インポート機能での既存スタックとの統合

### 2. UI/UX改善（Priority: Medium-High）

#### 2.1 UI経由のスタック操作
**概要**: マウスクリックでのスタック操作

**実装案**:
- スタック行のクリックでペースト実行
- 右クリックメニューでの編集・削除
- ドラッグ&ドロップでの順序変更
- スタック内容のプレビューポップアップ

**技術的考慮**:
- egui でのクリックイベント処理
- IPC でのUI操作→デーモン連携
- 操作フィードバックの視覚化

#### 2.2 高度なUI機能
**概要**: より直感的で効率的なUI

**実装案**:
- **検索・フィルタ機能**: スタック内容での検索
- **タグ・カテゴリ機能**: スタックの分類管理
- **プレビュー詳細表示**: 全文表示モード
- **キーボードショートカット**: 数字キーでの直接ペースト

#### 2.3 設定システム
**概要**: ユーザーカスタマイズ可能な設定

**実装案**:
```rust
// 設定項目例
pub struct VoiceInputConfig {
    pub max_stacks: usize,           // 最大スタック数
    pub preview_length: usize,       // プレビュー文字数
    pub ui_transparency: f32,        // UI透明度
    pub auto_paste_delay: Duration,  // 自動ペースト間隔
    pub hotkeys: HashMap<String, String>, // ホットキー設定
}
```

**技術的考慮**:
- 設定ファイル管理（TOML, JSON等）
- UI での設定画面実装
- 設定変更の動的反映

### 3. パフォーマンス・品質改善（Priority: Low-Medium）

#### 3.1 永続化機能
**概要**: スタックデータの永続化オプション

**実装案**:
- **セッション永続化**: デーモン再起動でもスタック保持
- **データベース連携**: SQLite等での履歴管理
- **クラウド同期**: 複数デバイス間でのスタック共有

**注意**: 現在の設計思想（オンメモリ管理）との整合性要検討

#### 3.2 メモリ・パフォーマンス最適化
**概要**: より効率的なリソース使用

**改善案**:
- スタック内容の圧縮保存
- アイドル時のメモリ解放
- UI描画の最適化（仮想スクロール等）
- バックグラウンド処理の最適化

#### 3.3 エラーハンドリング拡張
**概要**: より堅牢なエラー処理

**改善案**:
- 音声認識失敗時のリトライ機能
- UI プロセス異常時の自動復旧
- データ破損時の復旧機能
- 詳細なログ・診断機能

### 4. エコシステム拡張（Priority: Low）

#### 4.1 プラグインシステム
**概要**: サードパーティ拡張機能

**実装案**:
- **プラグインAPI**: 外部スクリプトでの機能拡張
- **フック機能**: スタック保存/ペースト時の処理挿入
- **カスタムコマンド**: ユーザー定義コマンドの追加

#### 4.2 他アプリケーション連携
**概要**: 外部アプリケーションとの統合

**連携候補**:
- **テキストエディタ**: VSCode, Vim等での直接連携
- **ブラウザ**: Web フォームへの直接入力
- **メモアプリ**: Bear, Obsidian等との連携
- **チャットアプリ**: Slack, Discord等への投稿

#### 4.3 API外部公開
**概要**: 他の開発者・アプリケーションからの利用

**実装案**:
- **REST API**: HTTP経由でのスタック操作
- **WebSocket API**: リアルタイムイベント配信
- **コマンドライン SDK**: 他のCLIツールからの利用

### 5. 国際化・アクセシビリティ（Priority: Low）

#### 5.1 多言語対応
**概要**: 英語以外の言語でのUI・メッセージ

**対応言語候補**:
- 英語（English）
- 中国語（简体中文）
- 韓国語（한국어）

#### 5.2 アクセシビリティ改善
**概要**: 障害を持つユーザーへの配慮

**改善案**:
- スクリーンリーダー対応
- ハイコントラストモード
- 大きなフォントサイズ対応
- キーボードのみでの操作

## 実装優先度マトリックス

| 機能 | 実装難易度 | ユーザー価値 | 優先度 |
|------|-----------|-------------|--------|
| 複数ペースト | Medium | High | **High** |
| UI経由スタック操作 | Medium | High | **High** |
| 設定システム | Medium | Medium | **Medium** |
| スタック編集機能 | Medium | Medium | **Medium** |
| 外部フォーマット連携 | Medium-High | Medium | **Medium** |
| 永続化機能 | High | Medium | **Low-Medium** |
| プラグインシステム | High | Low | **Low** |
| 多言語対応 | Medium | Low | **Low** |

## 次のPhase提案

### Phase 5: 複数ペースト機能とUI操作強化
**目的**: 最も価値の高い機能拡張を実装

**範囲**:
- 複数ペースト機能（範囲指定、全件ペースト）
- UI経由でのスタック操作（クリック、右クリックメニュー）
- 基本的な設定システム

**期間見積もり**: 2-3週間

### Phase 6: 外部連携とエコシステム拡張
**目的**: 他のツール・ワークフローとの統合

**範囲**:
- クリップボード連携
- ファイルエクスポート/インポート
- 基本的なAPI外部公開

**期間見積もり**: 3-4週間

## 技術的考慮事項

### アーキテクチャ影響
- 現在の別プロセスUI方式は拡張性に優れ、多くの改善案に対応可能
- IPC通信の拡張により新機能追加が比較的容易
- StackService の設計が柔軟で、機能追加が安全

### 互換性維持
- 既存CLI コマンドの互換性は必須
- 新機能はオプトイン形式で実装
- 既存ワークフローを破綻させない設計

### パフォーマンス影響
- 新機能追加時もパフォーマンス目標の維持が必要
- メモリ使用量の監視と制限
- UI応答性の維持

## 結論

マルチスタッキング機能は現在 **Production Ready** レベルに到達しており、基本的な音声入力ワークフローを大幅に改善しています。上記の改善案は、さらなる使いやすさとパワーユーザー向け機能の実現を目指すものです。

実装優先度としては、**複数ペースト機能**と**UI経由操作**が最も価値が高く、これらの実装により音声入力の効率性がさらに向上すると考えられます。

---

**分析実施日**: 2025年1月現在  
**基準バージョン**: Phase 4完了時点  
**次回見直し**: Phase 5完了後、または3ヶ月後