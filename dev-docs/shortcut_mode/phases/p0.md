# Phase 0: ショートカットキー競合調査 詳細設計書

## Why（概要・目的）

### Phase 概要
ショートカットキーモード実装前の事前調査フェーズ。macOS環境における既存アプリケーションとのキーバインド競合を包括的に調査し、ユーザビリティとシステム安定性を両立する最適なキーバインド設計を策定する。

### 目的
- **競合リスク最小化**: 主要アプリケーションとの競合を事前特定し、ユーザーの既存ワークフローを阻害しない
- **技術制約把握**: macOSアクセシビリティ権限、グローバルフック制限事項の詳細調査
- **代替案策定**: 競合回避のための複数代替キーバインド案を設計し、優先順位付け
- **実装戦略決定**: 技術調査結果に基づく具体的な実装アプローチの選定

## What（システム仕様）

### 調査対象アーキテクチャ

```
[調査領域]
├── macOSシステムショートカット
│   ├── Mission Control (Cmd+F3等)
│   ├── Spotlight (Cmd+Space)
│   └── システム環境設定系
├── 主要ブラウザ
│   ├── Safari (Cmd+R, Cmd+1-9)
│   ├── Chrome (Cmd+R, Cmd+1-9)
│   └── Firefox (Cmd+R, Cmd+1-9)
├── 開発環境
│   ├── VSCode (Cmd+R)
│   ├── Xcode (Cmd+R)
│   └── Terminal系
└── 音声入力システム
    ├── 既存IPCコマンド構造
    ├── UiProcessManager連携
    └── StackService統合点
```

### 調査フロー図

```mermaid
graph TD
    A[Phase 0 開始] --> B[システム調査]
    B --> C[アプリケーション調査]
    C --> D[技術制約調査]
    D --> E[競合分析]
    E --> F[代替案策定]
    F --> G[推奨キーバインド決定]
    
    B --> B1[macOSデフォルト<br>ショートカット列挙]
    B --> B2[アクセシビリティ権限<br>要件調査]
    
    C --> C1[Safari/Chrome/Firefox<br>競合確認]
    C --> C2[開発環境アプリ<br>競合確認]
    C --> C3[その他主要アプリ<br>競合確認]
    
    D --> D1[rdevライブラリ<br>制限事項調査]
    D --> D2[グローバルフック<br>性能調査]
    
    E --> E1[競合リスク<br>評価マトリクス作成]
    E --> E2[影響度分析]
    
    F --> F1[代替キーバインド<br>候補リスト作成]
    F --> F2[ユーザビリティ<br>評価]
    
    G --> H[Phase 0 完了]
```

### 成果物（機能要件）

#### 競合調査レポート

```markdown
# 競合調査レポート構造
## 1. システムレベル競合
### 1.1 macOSデフォルトショートカット
- Mission Control: Cmd+F3, Ctrl+↑
- Spotlight: Cmd+Space
- システム環境設定: Cmd+,

### 1.2 アクセシビリティ機能
- VoiceOver: Cmd+F5
- 拡大/縮小: Cmd+Option+=

## 2. アプリケーション競合マトリクス
| キー | Safari | Chrome | VSCode | Terminal | Slack | Zoom | Mail | Pages | メモ |
|------|--------|--------|---------|----------|-------|------|------|-------|------|
| Cmd+R | 🔴 | 🔴 | 🔴 | 🟡 | ⚪ | ⚪ | 🔴 | ⚪ | ⚪ |
| Cmd+1 | 🔴 | 🔴 | 🟡 | ⚪ | ⚪ | ⚪ | ⚪ | ⚪ | ⚪ |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |
```

#### 技術制約ドキュメント

```rust
// アクセシビリティ権限チェック例
pub fn check_accessibility_permissions() -> Result<bool, String> {
    // macOSアクセシビリティ権限の確認
    // AXIsProcessTrusted() を使用した実装例
}

// グローバルキーフック制約
pub struct GlobalKeyHookConstraints {
    pub requires_accessibility: bool,
    pub blocked_system_keys: Vec<String>,
    pub performance_impact: KeyHookPerformance,
}
```

#### 代替キーバインド候補

```rust
// 推奨キーバインド設定
pub struct ShortcutConfig {
    pub primary_option: KeyBindingSet,
    pub fallback_options: Vec<KeyBindingSet>,
    pub conflict_risk: RiskLevel,
}

pub struct KeyBindingSet {
    pub record_toggle: String,    // "Cmd+R" -> "Cmd+Shift+R"
    pub stack_access: Vec<String>, // ["Cmd+1-9"] -> ["Cmd+Opt+1-9"]
    pub stack_clear: String,      // "Cmd+C" -> "Cmd+Shift+C"
}
```

### 成果物（非機能要件）

#### パフォーマンス調査
- グローバルキーフック応答時間測定（目標: <10ms）
- メモリ使用量調査（目標: <5MB追加）
- CPU使用率影響調査（目標: <1%追加）

#### 安定性調査
- 長時間稼働テスト設計
- 権限エラー時のフォールバック動作定義
- システムスリープ/復帰時の動作確認項目

## How（実装手順）

### 目的
事前調査により、ショートカットキーモード実装時の技術的・ユーザビリティ的リスクを最小化し、最適な実装戦略を策定する。さらに、ショートカットキー動作確認プログラムを作成し、実機での基本的なキー検出動作を確認する。

### 成果物（モジュール/ファイル）
- `examples/shortcut_key_test.rs` （新規：キー動作確認プログラム）
- `Cargo.toml` （rdev依存関係追加）
- `dev-docs/shortcut_mode/keybinding_recommendations.md` （実際のテスト結果に基づく代替案）

### 完了条件
- [ ] **ショートカットキー動作確認プログラム実装完了**
- [ ] **実機でのキー検出動作確認完了**
- [ ] **アクセシビリティ権限要求の動作確認完了**
- [ ] **主要アプリケーションとの競合動作確認完了**
- [ ] **代替キーバインド候補策定完了**

### タスク分割

#### 🤖 実装タスク（AI実行）

- [ ] **キー動作確認プログラム実装**
  - [ ] rdev依存関係をCargo.tomlに追加
  - [ ] 基本的なキー検出プログラム実装（examples/shortcut_key_test.rs）
  - [ ] Cmd+R、Cmd+1-9の検出とコンソール出力
  - [ ] アクセシビリティ権限チェック機能実装
  - [ ] 基本的なエラーハンドリング実装

#### 👤 手動検証タスク（ユーザー実行）

- [ ] **キー動作確認テスト**
  - [ ] キー動作確認プログラムを実際に実行してキー検出動作確認
  - [ ] アクセシビリティ権限の要求プロセス確認
  - [ ] 各種アプリケーション使用中のキー検出動作確認
  - [ ] システム負荷・応答性の体感確認
  - [ ] 権限なし状態でのエラーハンドリング確認

- [ ] **実機競合テスト**
  - [ ] Safari・ChromeでCmd+R実行し、実際の動作確認
  - [ ] Safari・ChromeでCmd+1-9実行し、実際の動作確認
  - [ ] VSCodeでCmd+R実行し、デバッグ動作確認
  - [ ] Terminal・Slack・Zoom・Mail・Pages・メモでCmd+R動作確認

#### 🔄 協調タスク（AI + ユーザー）

- [ ] **キー動作確認プログラム改善**
  - [ ] ユーザー: キー動作確認テスト結果フィードバック
  - [ ] AI: フィードバックに基づくプログラム改善
  - [ ] ユーザー: 改善版の再テスト・評価

- [ ] **競合分析とキーバインド策定**
  - [ ] ユーザー: 実際の競合状況・使用頻度報告
  - [ ] AI: 報告に基づく代替キーバインド案作成
  - [ ] ユーザー: 代替案の実用性・使いやすさ評価

### 手動チェック項目

#### キー動作確認プログラム確認
- [ ] プログラムが正常にビルド・実行できることを確認
- [ ] Cmd+R検出時のコンソール出力確認
- [ ] Cmd+1-9検出時のコンソール出力確認
- [ ] アクセシビリティ権限要求ダイアログの表示確認
- [ ] 権限取得後のキー検出動作確認

#### アプリケーション競合確認
- [ ] 各ブラウザで実際にCmd+Rを押してリロード動作確認
- [ ] 各ブラウザで実際にCmd+1-9を押してタブ/ブックマーク動作確認
- [ ] VSCodeで実際にCmd+Rを押してデバッグ実行確認
- [ ] 個人設定でカスタマイズされたショートカットの確認
- [ ] 業務で使用するアプリケーション固有の競合確認

### 除外項目（やらないこと）

#### Phase 0では実装しない項目
- [ ] IPCコマンドの拡張実装（キー動作確認プログラムは独立動作）
- [ ] UI コンポーネントの実装
- [ ] StackServiceとの統合
- [ ] 本格的なエラーハンドリングとリカバリ機能

#### Phase 0では調査しない項目
- [ ] Windows/Linux環境での競合調査
- [ ] 全アプリケーションの網羅的調査（主要アプリのみ）
- [ ] Web検索による技術調査
- [ ] ドキュメント作成

#### Phase 0では決定しない項目
- [ ] 最終的なライブラリ選択（rdev vs device_query）
- [ ] 詳細なUI設計
- [ ] 具体的な実装スケジュール
- [ ] 複雑なフォールバック機能の仕様

### 成功基準
- **キー動作確認プログラムが実機で動作し、基本的なキー検出機能が確認できている**
- **アクセシビリティ権限要求から取得までのプロセスが明確になっている**
- **実際の競合シナリオでのキー検出動作が確認できている**
- **実用的な代替キーバインド案が策定されている**
- **Phase 1以降の実装方針が明確になっている**