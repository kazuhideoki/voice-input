# ショートカットキーモード 全体設計書

## Why（概要・目的）

### 概要

StackingMode有効時に自動でショートカットキー制御を連動させ、スタック操作の効率性を劇的に向上させるシステム。スタッキングモード時の課題に特化したソリューション。

### 目的

- **操作効率の向上**: 5つのコマンド × 複数番号から1つのキーバインド設定のみに簡素化
- **認知負荷の軽減**: スタッキングモードのみ管理、ショートカット意識不要
- **ワークフロー統合**: スタック一覧確認とペースト操作のシームレス化
- **通常音声入力への影響ゼロ**: 既存ワークフローを完全保持

### 解決する課題

- 多数のキーバインディング設定が必要
- `paste <number>` コマンドでの複数番号対応設定の煩雑さ
- スタック一覧確認とペースト操作の分離

### 設計更新

- **スタック一覧オーバーレイのショートカットキーは不要**: スタックモード有効時に一覧オーバーレイは自動表示される（`StackService::enable_stack_mode()` → `UiProcessManager::start_ui()`）

## What（システム仕様）

### アーキテクチャ図

```
[現在]
[外部ランチャー] → [CLI] → [IPC] → [Daemon]

[提案後]
[Global Key Hook] → [Daemon] → [Direct Action]
                 ↓
[Stack Service] ←→ [Hotkey Manager] ←→ [Overlay UI]
```

### ディレクトリ構成

```
src/
├── hotkey/                      # 新規モジュール
│   ├── mod.rs                   # モジュール定義
│   ├── key_handler.rs          # グローバルキーフック
│   ├── overlay_ui.rs           # スタック一覧オーバーレイ
│   └── shortcut_mode.rs        # ショートカットモード管理
├── application/
│   └── stack_service.rs        # 拡張：ショートカット自動連動
├── bin/
│   └── voice_input_hotkey.rs   # 新規バイナリ（オプション）
└── ...
```

### システムフロー図

```mermaid
graph TD
    A[ユーザー: stack-mode on] --> B[StackService]
    B --> C[自動的にショートカットキー有効化]
    C --> D[HotkeyManager.enable_shortcuts]
    B --> E[UiProcessManager.start_ui]
    E --> F[オーバーレイUI自動表示]

    G[ユーザー: Cmd+R] --> H[KeyHandler]
    H --> I[IPC経由でDaemon通信]
    I --> J[録音開始/停止]

    K[ユーザー: Cmd+1-9] --> L[KeyHandler]
    L --> M[IPC経由でペーストコマンド]
    M --> N[対応番号のスタックペースト]

    O[ユーザー: stack-mode off] --> P[StackService]
    P --> Q[自動的にショートカットキー無効化]
    Q --> R[HotkeyManager.disable_shortcuts]
```

### 成果物（機能要件）

#### 自動連動機能

- スタックモード有効時の自動ショートカットキー有効化
- スタックモード無効時の自動ショートカットキー無効化
- 透明な状態管理（ユーザーはスタッキングモードのみ意識）

#### ショートカットキー機能

- `Cmd + R`: 録音開始/停止（トグル）
- `Cmd + 1-9`: 対応する番号のスタックを直接ペースト
- `Cmd + C`: 全スタッククリア

#### オーバーレイUI機能

- 軽量なスタック一覧表示（スタックモード有効時に自動表示）
- 番号選択による直接ペースト
- ESCキーによる終了

### 成果物（非機能要件）

#### パフォーマンス

- グローバルキーフックの低レイテンシ実装
- オーバーレイUI の高速表示（<100ms）
- 最小限のシステム負荷

#### 安定性

- macOSアクセシビリティ権限エラー時の適切なフォールバック
- キーフック機能のクラッシュ耐性
- 既存CLIコマンドとの併用可能性

#### セキュリティ

- キー入力の適切なフィルタリング
- システムレベルショートカットの回避
- 権限要求の明確なユーザー通知

## How（実装フェーズ）

| Phase                    | 目的                               | 成果物（モジュール/ファイル）                                                             | 完了条件                                                                                                            | 除外項目                                                                     |
| ------------------------ | ---------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| **P0: 事前調査**         | ショートカットキー競合調査         | 競合リスク調査レポート<br>推奨キーバインド案                                              | - Cmd+R、Cmd+1-9の既存アプリ競合調査完了<br>- Safari/Chrome/Firefox等との競合リスト作成<br>- 代替キーバインド案策定 | - 全アプリケーション網羅調査<br>- 自動競合回避機能<br>- 動的キーバインド変更 |
| **P1: 基盤実装**         | グローバルキーフックの基本機能実装 | `src/hotkey/key_handler.rs`<br>`src/hotkey/mod.rs`<br>`src/hotkey/shortcut_mode.rs`       | - 基本的なキー検出が動作<br>- macOSアクセシビリティ権限要求<br>- 基本的なエラーハンドリング                         | - UIコンポーネント<br>- 複雑な権限エラー対応<br>- パフォーマンス最適化       |
| **P2: IPC統合**          | 既存システムとの連携機能実装       | `src/application/stack_service.rs`（拡張）<br>`src/hotkey/key_handler.rs`（拡張）         | - ショートカットキーからIPCコマンド送信<br>- 基本的な録音・ペースト動作<br>- スタックモード連動テスト               | - オーバーレイUI<br>- 高度なエラー処理<br>- 全キーバインド実装               |
| **P3: 既存UI連携**       | 既存オーバーレイUIとの連携強化     | 既存UIコンポーネントの拡張<br>ショートカットキー統合                                      | - 既存オーバーレイとの連携確認<br>- キーボード操作の統合<br>- 番号選択機能の動作確認                                | - 新規UI開発<br>- 高度なUI装飾<br>- アニメーション                           |
| **P4: 自動連動システム** | スタックモードとの完全統合         | `src/application/stack_service.rs`（最終拡張）<br>`src/hotkey/shortcut_mode.rs`（最終版） | - stack-mode on/offでの自動切り替え<br>- 透明な状態管理<br>- フォールバック機能確保                                 | - 複雑な設定オプション<br>- 他アプリケーション連携<br>- 高度なカスタマイズ   |
| **P5: 品質向上**         | テスト・最適化・ドキュメント       | テストスイート<br>パフォーマンス最適化<br>エラーハンドリング強化                          | - 全機能の統合テスト<br>- パフォーマンス要件達成<br>- エラーケース対応完了                                          | - 新機能追加<br>- 大幅なアーキテクチャ変更<br>- 他プラットフォーム対応       |

### 技術選択

- **実装アプローチ**: Hybrid approach（Rust + 既存IPC）
- **キーフックライブラリ**: `rdev`（推奨）
  - **メリット**: 真のグローバルフック、低レイテンシ、イベント駆動
  - **デメリット**: アクセシビリティ権限必須、無音失敗
- **UI実装**: 既存オーバーレイUIの活用

### ショートカットキー競合リスク

- **Cmd+R**: Safari/Chrome/Firefox等のリフレッシュ機能と競合
- **Cmd+1-9**: Safari（ブックマーク）、Chrome/Firefox（タブ切り替え）と競合
- **対策**: P0フェーズで詳細調査し、代替キーバインド案を策定
